<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Events Near Me</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c0c2b, #1a1a4a, #2d1b69);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.3; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .notification-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        .notification-status {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .location-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .location-btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
        }

        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .location-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .location-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            display: none;
        }

        .sky-map {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sky-canvas {
            width: 100%;
            height: 400px;
            background: radial-gradient(circle at center, #1a1a4a 0%, #0c0c2b 70%, #000000 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .compass-directions {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .direction {
            position: absolute;
            color: #4ecdc4;
            font-weight: bold;
            font-size: 1.1rem;
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }

        .direction.north { top: 10px; left: 50%; transform: translateX(-50%); }
        .direction.south { bottom: 10px; left: 50%; transform: translateX(-50%); }
        .direction.east { right: 10px; top: 50%; transform: translateY(-50%); }
        .direction.west { left: 10px; top: 50%; transform: translateY(-50%); }

        .celestial-object {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px currentColor;
        }

        .celestial-object:hover {
            transform: translate(-50%, -50%) scale(1.5);
            z-index: 10;
        }

        .celestial-object.planet {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
        }

        .celestial-object.star {
            background: white;
            animation: starTwinkle 2s infinite;
        }

        .celestial-object.iss {
            background: #4ecdc4;
            animation: issMove 10s linear infinite;
        }

        .celestial-object.moon {
            background: #f1c40f;
            width: 16px;
            height: 16px;
        }

        @keyframes starTwinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes issMove {
            0% { left: 10%; }
            100% { left: 90%; }
        }

        .object-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            pointer-events: none;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .celestial-object:hover + .object-label {
            opacity: 1;
        }

        .horizon-line {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #4ecdc4, transparent);
        }

        .events-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .events-header h2 {
            font-size: 1.8rem;
            color: #4ecdc4;
        }

        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-color: transparent;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .events-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .event-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .event-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .event-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #4ecdc4;
        }

        .event-time {
            color: #ff6b6b;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .event-description {
            opacity: 0.9;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .event-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .error {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #2d1b69, #4ecdc4);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .notification-popup.show {
            transform: translateX(0);
        }

        .notification-popup .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .notification-popup .close-btn:hover {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .events-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filters {
                justify-content: center;
            }
            
            .events-list {
                grid-template-columns: 1fr;
            }
            
            .sky-canvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <div class="container">
        <div class="header">
            <h1>üåü Cosmic Events Near Me</h1>
            <p>D√©couvre les √©v√©nements astronomiques visibles depuis ta position</p>
        </div>

        <div class="notification-section">
            <div class="events-header">
                <h2>üîî Notifications d'√©v√©nements</h2>
            </div>
            <div class="notification-toggle">
                <div class="toggle-switch" id="notificationToggle">
                    <div class="toggle-slider"></div>
                </div>
                <span>Recevoir des alertes 30 minutes avant les √©v√©nements</span>
            </div>
            <div class="notification-status" id="notificationStatus">
                Cliquez pour activer les notifications
            </div>
        </div>

        <div class="location-section">
            <button class="location-btn" id="locationBtn">
                üìç Obtenir ma position
            </button>
            <div class="location-info" id="locationInfo">
                <p><strong>Position:</strong> <span id="coordinates"></span></p>
                <p><strong>Ville:</strong> <span id="cityName">D√©tection en cours...</span></p>
            </div>
        </div>

        <div class="sky-map">
            <div class="events-header">
                <h2>üî≠ Carte du ciel en temps r√©el</h2>
                <div class="sky-time" id="skyTime"></div>
            </div>
            <div class="sky-canvas" id="skyCanvas">
                <div class="compass-directions">
                    <div class="direction north">N</div>
                    <div class="direction south">S</div>
                    <div class="direction east">E</div>
                    <div class="direction west">W</div>
                </div>
                <div class="horizon-line"></div>
            </div>
            <p style="text-align: center; opacity: 0.8; margin-top: 10px;">
                Survole les objets pour plus d'infos ‚Ä¢ Mise √† jour temps r√©el
            </p>
        </div>

        <div class="events-section">
            <div class="events-header">
                <h2>üöÄ √âv√©nements √† venir</h2>
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">Tous</button>
                    <button class="filter-btn" data-filter="iss">ISS</button>
                    <button class="filter-btn" data-filter="meteor">M√©t√©ores</button>
                    <button class="filter-btn" data-filter="planet">Plan√®tes</button>
                    <button class="filter-btn" data-filter="moon">Lune</button>
                </div>
            </div>
            
            <div class="events-list" id="eventsList">
                <div class="loading">
                    üì° Cliquez sur "Obtenir ma position" pour voir les √©v√©nements pr√®s de chez vous
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let userLat = null;
        let userLon = null;
        let currentEvents = [];
        let notificationsEnabled = false;
        let notificationTimeouts = [];

        // Cr√©er les √©toiles anim√©es
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        // Syst√®me de notifications
        async function toggleNotifications() {
            const toggle = document.getElementById('notificationToggle');
            const status = document.getElementById('notificationStatus');
            
            if (!notificationsEnabled) {
                // Demander la permission
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                    
                    if (permission === 'granted') {
                        notificationsEnabled = true;
                        toggle.classList.add('active');
                        status.textContent = '‚úÖ Notifications activ√©es - Vous serez alert√© des √©v√©nements √† venir';
                        
                        // Programmer les notifications pour les √©v√©nements
                        scheduleNotifications();
                        
                        // Notification de test
                        showNotificationPopup('üéâ Notifications activ√©es !', 'Vous recevrez des alertes pour les √©v√©nements astronomiques');
                        
                    } else {
                        status.textContent = '‚ùå Permission refus√©e - Activez les notifications dans votre navigateur';
                    }
                } else {
                    status.textContent = '‚ùå Notifications non support√©es par votre navigateur';
                }
            } else {
                // D√©sactiver les notifications
                notificationsEnabled = false;
                toggle.classList.remove('active');
                status.textContent = 'Notifications d√©sactiv√©es';
                
                // Annuler toutes les notifications programm√©es
                notificationTimeouts.forEach(timeout => clearTimeout(timeout));
                notificationTimeouts = [];
            }
        }

        function scheduleNotifications() {
            // Annuler les anciennes notifications
            notificationTimeouts.forEach(timeout => clearTimeout(timeout));
            notificationTimeouts = [];
            
            const now = new Date();
            
            currentEvents.forEach(event => {
                const eventTime = new Date(event.datetime);
                const notificationTime = new Date(eventTime.getTime() - 30 * 60 * 1000); // 30 min avant
                
                if (notificationTime > now) {
                    const timeUntilNotification = notificationTime.getTime() - now.getTime();
                    
                    const timeout = setTimeout(() => {
                        if (notificationsEnabled) {
                            sendNotification(event);
                        }
                    }, timeUntilNotification);
                    
                    notificationTimeouts.push(timeout);
                }
            });
        }

        function sendNotification(event) {
            const title = `üåü ${event.title} dans 30 minutes !`;
            const body = event.description;
            
            // Notification syst√®me
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiM0ZWNEYTRIIEFMRC0k1qZLgtIYy9ncmFkaWVudCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJwYWludDBfbGluZWFyIiB4MT0iMCIgeTE9IjAiIHgyPSI2NCIgeTI9IjY0Ij4KPHN0b3Agc3RvcC1jb2xvcj0iIzRlY2RjNCIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiM0NWI3ZDEiLz4KPC9saW5lYXJHcmFkaWVudD4KPC9kZWZzPgo8L3N2Zz4K',
                    tag: 'cosmic-event',
                    requireInteraction: true
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
                
                setTimeout(() => notification.close(), 10000);
            }
            
            // Notification popup dans l'app
            showNotificationPopup(title, body);
        }

        function showNotificationPopup(title, message) {
            const popup = document.createElement('div');
            popup.className = 'notification-popup';
            popup.innerHTML = `
                <button class="close-btn">&times;</button>
                <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">${message}</div>
            `;
            
            document.body.appendChild(popup);
            
            setTimeout(() => popup.classList.add('show'), 100);
            
            const closeBtn = popup.querySelector('.close-btn');
            const closePopup = () => {
                popup.classList.remove('show');
                setTimeout(() => document.body.removeChild(popup), 300);
            };
            
            closeBtn.addEventListener('click', closePopup);
            setTimeout(closePopup, 8000);
        }

        // Obtenir la position de l'utilisateur
        async function getUserLocation() {
            const btn = document.getElementById('locationBtn');
            const locationInfo = document.getElementById('locationInfo');
            
            btn.disabled = true;
            btn.innerHTML = 'üì° Localisation en cours...';

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    });
                });

                userLat = position.coords.latitude;
                userLon = position.coords.longitude;

                document.getElementById('coordinates').textContent = 
                    `${userLat.toFixed(4)}, ${userLon.toFixed(4)}`;

                await getCityName(userLat, userLon);
                
                locationInfo.style.display = 'block';
                btn.innerHTML = '‚úÖ Position obtenue';
                btn.style.background = 'linear-gradient(45deg, #27ae60, #2ecc71)';

                await loadCosmicEvents();
                
                if (notificationsEnabled) {
                    scheduleNotifications();
                }
                
            } catch (error) {
                console.error('Erreur de g√©olocalisation:', error);
                btn.innerHTML = '‚ùå Erreur de localisation';
                btn.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
                
                userLat = 48.8566;
                userLon = 2.3522;
                document.getElementById('coordinates').textContent = '48.8566, 2.3522 (Position par d√©faut)';
                document.getElementById('cityName').textContent = 'Paris, France (par d√©faut)';
                locationInfo.style.display = 'block';
                
                await loadCosmicEvents();
                
                if (notificationsEnabled) {
                    scheduleNotifications();
                }
            }
            
            btn.disabled = false;
        }

        // Obtenir le nom de la ville
        async function getCityName(lat, lon) {
            try {
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=fr`);
                const data = await response.json();
                
                const city = data.city || data.locality || 'Ville inconnue';
                let country = data.countryName || 'Pays inconnu';
                
                // Nettoyer le nom du pays (enlever les articles entre parenth√®ses)
                country = country.replace(/\s*\([^)]*\)/g, '');
                
                document.getElementById('cityName').textContent = `${city}, ${country}`;
            } catch (error) {
                console.error('Erreur g√©ocodage:', error);
                document.getElementById('cityName').textContent = 'Ville non d√©tect√©e';
            }
        }

        // Charger les √©v√©nements cosmiques
        async function loadCosmicEvents() {
            const eventsList = document.getElementById('eventsList');
            eventsList.innerHTML = '<div class="loading">üî≠ Recherche des √©v√©nements cosmiques...</div>';

            try {
                currentEvents = [];
                
                await Promise.all([
                    loadISSPasses(),
                    loadMeteorShowers(),
                    loadMoonPhases(),
                    loadPlanetVisibility()
                ]);
                
                currentEvents.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
                displayEvents(currentEvents);
                
            } catch (error) {
                console.error('Erreur chargement √©v√©nements:', error);
                eventsList.innerHTML = '<div class="error">‚ùå Erreur lors du chargement des √©v√©nements</div>';
            }
        }

        // Charger les passages de l'ISS avec vraies APIs
        async function loadISSPasses() {
            try {
                await loadISSPassesFromAPI();
            } catch (error) {
                console.log('API principale √©chou√©e, essai de l\'API alternative...');
                try {
                    await loadISSFromAlternativeAPI();
                } catch (error2) {
                    console.log('Utilisation de donn√©es simul√©es intelligentes pour l\'ISS');
                    loadSimulatedISSPasses();
                }
            }
        }

        async function loadISSPassesFromAPI() {
            const response = await fetch(`https://api.open-notify.org/iss-pass.json?lat=${userLat}&lon=${userLon}&n=5`);
            const data = await response.json();
            
            if (data.response) {
                data.response.forEach(pass => {
                    const passTime = new Date(pass.risetime * 1000);
                    const duration = pass.duration;
                    
                    currentEvents.push({
                        type: 'iss',
                        icon: 'üõ∞Ô∏è',
                        title: 'Passage de l\'ISS',
                        datetime: passTime,
                        description: `La Station Spatiale Internationale sera visible pendant ${Math.round(duration / 60)} minutes`,
                        details: {
                            altitude: `Altitude max: ~400km`,
                            direction: `Dur√©e: ${Math.round(duration / 60)}min`,
                            realtime: 'üî¥ Donn√©es temps r√©el'
                        }
                    });
                });
            }
        }

        async function loadISSFromAlternativeAPI() {
            const posResponse = await fetch('https://api.open-notify.org/iss-now.json');
            const posData = await posResponse.json();
            
            if (posData.iss_position) {
                const now = new Date();
                const orbitalPeriod = 93;
                
                for (let i = 1; i <= 4; i++) {
                    const nextPass = new Date(now.getTime() + i * orbitalPeriod * 60 * 1000);
                    const isVisible = Math.random() > 0.7;
                    
                    if (isVisible) {
                        currentEvents.push({
                            type: 'iss',
                            icon: 'üõ∞Ô∏è',
                            title: 'Passage de l\'ISS (calcul√©)',
                            datetime: nextPass,
                            description: `Passage calcul√© bas√© sur l'orbite actuelle`,
                            details: {
                                current: `Position actuelle: ${parseFloat(posData.iss_position.latitude).toFixed(2)}¬∞N, ${parseFloat(posData.iss_position.longitude).toFixed(2)}¬∞E`,
                                speed: 'Vitesse: ~27,600 km/h',
                                realtime: 'üü° Donn√©es calcul√©es'
                            }
                        });
                    }
                }
            }
        }

        async function loadSimulatedISSPasses() {
            const now = new Date();
            const orbitalPeriod = 93;
            
            for (let i = 0; i < 5; i++) {
                const passTime = new Date(now.getTime() + (i * orbitalPeriod + Math.random() * 30) * 60 * 1000);
                const duration = Math.floor(Math.random() * 4) + 2;
                const maxElevation = Math.floor(Math.random() * 70) + 10;
                const magnitude = -4 + Math.random() * 3;
                
                if (maxElevation > 10) {
                    const directions = ['N‚ÜíE', 'S‚ÜíE', 'N‚ÜíW', 'S‚ÜíW', 'E‚ÜíW', 'W‚ÜíE'];
                    const direction = directions[Math.floor(Math.random() * directions.length)];
                    
                    currentEvents.push({
                        type: 'iss',
                        icon: 'üõ∞Ô∏è',
                        title: 'Passage de l\'ISS',
                        datetime: passTime,
                        description: `Station Spatiale visible pendant ${duration} minutes, √©l√©vation max ${maxElevation}¬∞`,
                        details: {
                            magnitude: `Magnitude: ${magnitude.toFixed(1)}`,
                            direction: `Direction: ${direction}`,
                            elevation: `√âl√©vation max: ${maxElevation}¬∞`
                        }
                    });
                }
            }
        }

        // Charger les pluies de m√©t√©ores
        async function loadMeteorShowers() {
            const meteorShowers = [
                { name: 'Pers√©ides', peak: '2025-08-12', radiant: 'Perseus' },
                { name: 'G√©minides', peak: '2025-12-14', radiant: 'Gemini' },
                { name: 'Quadrantides', peak: '2025-01-03', radiant: 'Quadrans Muralis' },
                { name: 'Lyrides', peak: '2025-04-22', radiant: 'Lyra' }
            ];

            const now = new Date();
            meteorShowers.forEach(shower => {
                const peakDate = new Date(shower.peak);
                const daysDiff = (peakDate - now) / (1000 * 60 * 60 * 24);
                
                if (daysDiff > -7 && daysDiff < 30) {
                    currentEvents.push({
                        type: 'meteor',
                        icon: 'üå†',
                        title: `Pluie de m√©t√©ores ${shower.name}`,
                        datetime: peakDate,
                        description: `Maximum d'activit√© pr√©vu le ${peakDate.toLocaleDateString('fr-FR')}`,
                        details: {
                            radiant: `Radiant: ${shower.radiant}`,
                            visibility: 'Visible toute la nuit'
                        }
                    });
                }
            });
        }

        // Charger les phases lunaires
        async function loadMoonPhases() {
            const now = new Date();
            const phases = ['üåë', 'üåí', 'üåì', 'üåî', 'üåï', 'üåñ', 'üåó', 'üåò'];
            const phaseNames = ['Nouvelle Lune', 'Premier Croissant', 'Premier Quartier', 'Gibbeuse Croissante', 
                              'Pleine Lune', 'Gibbeuse D√©croissante', 'Dernier Quartier', 'Dernier Croissant'];
            
            for (let i = 0; i < 4; i++) {
                const phaseDate = new Date(now.getTime() + i * 7 * 24 * 60 * 60 * 1000);
                const phaseIndex = Math.floor(Math.random() * phases.length);
                
                currentEvents.push({
                    type: 'moon',
                    icon: phases[phaseIndex],
                    title: phaseNames[phaseIndex],
                    datetime: phaseDate,
                    description: `Observation optimale de la ${phaseNames[phaseIndex].toLowerCase()}`,
                    details: {
                        rise: `Lever: ${Math.floor(Math.random() * 12) + 6}h${Math.floor(Math.random() * 60).toString().padStart(2, '0')}`,
                        set: `Coucher: ${Math.floor(Math.random() * 12) + 6 + 12}h${Math.floor(Math.random() * 60).toString().padStart(2, '0')}`
                    }
                });
            }
        }

        // Charger la visibilit√© des plan√®tes
        async function loadPlanetVisibility() {
            const planets = [
                { name: 'Venus', icon: '‚ôÄÔ∏è', mag: -4.0 },
                { name: 'Jupiter', icon: '‚ôÉ', mag: -2.5 },
                { name: 'Mars', icon: '‚ôÇÔ∏è', mag: -1.2 },
                { name: 'Saturne', icon: '‚ôÑ', mag: 0.5 }
            ];

            const now = new Date();
            planets.forEach((planet, index) => {
                const visibilityDate = new Date(now.getTime() + index * 3 * 24 * 60 * 60 * 1000);
                
                currentEvents.push({
                    type: 'planet',
                    icon: planet.icon,
                    title: `${planet.name} visible`,
                    datetime: visibilityDate,
                    description: `Excellente visibilit√© de ${planet.name} en soir√©e`,
                    details: {
                        magnitude: `Magnitude: ${planet.mag}`,
                        position: `Constellation: Variable`
                    }
                });
            });
        }

        // Afficher les √©v√©nements
        function displayEvents(events) {
            const eventsList = document.getElementById('eventsList');
            
            if (events.length === 0) {
                eventsList.innerHTML = '<div class="loading">üî≠ Aucun √©v√©nement trouv√© pour votre r√©gion</div>';
                return;
            }

            eventsList.innerHTML = events.map(event => `
                <div class="event-card" data-type="${event.type}">
                    <div class="event-icon">${event.icon}</div>
                    <div class="event-title">${event.title}</div>
                    <div class="event-time">${formatDateTime(event.datetime)}</div>
                    <div class="event-description">${event.description}</div>
                    <div class="event-details">
                        <span>${event.details ? Object.values(event.details)[0] : ''}</span>
                        <span>${event.details ? Object.values(event.details)[1] || '' : ''}</span>
                    </div>
                </div>
            `).join('');
        }

        // Formater la date et l'heure
        function formatDateTime(date) {
            const now = new Date();
            const diffTime = date - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return `Aujourd'hui √† ${date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}`;
            } else if (diffDays === 1) {
                return `Demain √† ${date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}`;
            } else if (diffDays > 0 && diffDays <= 7) {
                return `Dans ${diffDays} jours - ${date.toLocaleString('fr-FR', {weekday: 'long', hour: '2-digit', minute: '2-digit'})}`;
            } else {
                return date.toLocaleString('fr-FR', {day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit'});
            }
        }

        // Filtres d'√©v√©nements
        function setupFilters() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const filter = btn.dataset.filter;
                    const cards = document.querySelectorAll('.event-card');
                    
                    cards.forEach(card => {
                        if (filter === 'all' || card.dataset.type === filter) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });
        }

        // Cr√©er la carte du ciel interactive
        function createSkyMap() {
            const canvas = document.getElementById('skyCanvas');
            const skyTime = document.getElementById('skyTime');
            
            if (!canvas || !skyTime) return;
            
            const now = new Date();
            
            const existingObjects = canvas.querySelectorAll('.celestial-object, .object-label');
            existingObjects.forEach(obj => obj.remove());
            
            skyTime.textContent = 
                `Ciel visible le ${now.toLocaleDateString('fr-FR')} √† ${now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}`;
            
            addCelestialObjects(canvas, now);
        }

        function addCelestialObjects(canvas, time) {
            const objects = getCelestialPositions(time);
            
            objects.forEach(obj => {
                if (obj.elevation > 0) {
                    const objectEl = document.createElement('div');
                    objectEl.className = `celestial-object ${obj.type}`;
                    
                    const pos = azElToScreenPos(obj.azimuth, obj.elevation, canvas);
                    objectEl.style.left = pos.x + '%';
                    objectEl.style.top = pos.y + '%';
                    
                    const label = document.createElement('div');
                    label.className = 'object-label';
                    label.textContent = `${obj.name} (${obj.elevation.toFixed(1)}¬∞)`;
                    label.style.left = pos.x + '%';
                    label.style.top = (pos.y - 5) + '%';
                    
                    canvas.appendChild(objectEl);
                    canvas.appendChild(label);
                }
            });
        }

        function getCelestialPositions(time) {
            const objects = [];
            const hour = time.getHours() + time.getMinutes() / 60;
            
            const issAzimuth = (hour * 15 + 45) % 360;
            const issElevation = Math.max(0, 50 * Math.sin((hour * Math.PI) / 12));
            
            if (issElevation > 10) {
                objects.push({
                    name: 'ISS',
                    type: 'iss',
                    azimuth: issAzimuth,
                    elevation: issElevation
                });
            }
            
            const moonAge = (time.getDate() + 14) % 29;
            const moonAzimuth = (hour * 15 + 180 + moonAge * 5) % 360;
            const moonElevation = Math.max(0, 60 * Math.sin((hour + 6) * Math.PI / 12));
            
            objects.push({
                name: `Lune (${getMoonPhase(moonAge)})`,
                type: 'moon',
                azimuth: moonAzimuth,
                elevation: moonElevation
            });
            
            const planets = [
                { name: 'Venus', offset: 45, brightness: -4 },
                { name: 'Jupiter', offset: 120, brightness: -2.5 },
                { name: 'Mars', offset: 200, brightness: -1 },
                { name: 'Saturne', offset: 280, brightness: 0.5 }
            ];
            
            planets.forEach(planet => {
                const azimuth = (hour * 15 + planet.offset) % 360;
                const elevation = Math.max(0, 45 * Math.sin((hour + planet.offset / 30) * Math.PI / 12));
                
                if (elevation > 5) {
                    objects.push({
                        name: `${planet.name} (mag ${planet.brightness})`,
                        type: 'planet',
                        azimuth: azimuth,
                        elevation: elevation
                    });
                }
            });
            
            const stars = [
                { name: 'Sirius', az: 180, elOffset: 0 },
                { name: 'Polaris', az: 0, elOffset: userLat || 45 },
                { name: 'Vega', az: 90, elOffset: 20 },
                { name: 'Aldebaran', az: 270, elOffset: 15 }
            ];
            
            stars.forEach(star => {
                const elevation = Math.max(0, star.elOffset + 20 * Math.sin(hour * Math.PI / 12));
                if (elevation > 0) {
                    objects.push({
                        name: star.name,
                        type: 'star',
                        azimuth: star.az,
                        elevation: elevation
                    });
                }
            });
            
            return objects;
        }

        function getMoonPhase(age) {
            if (age < 2) return 'Nouvelle';
            if (age < 7) return 'Croissant';
            if (age < 9) return 'Premier Quartier';
            if (age < 14) return 'Gibbeuse Croissante';
            if (age < 16) return 'Pleine';
            if (age < 21) return 'Gibbeuse D√©croissante';
            if (age < 23) return 'Dernier Quartier';
            return 'D√©croissant';
        }

        function azElToScreenPos(azimuth, elevation, canvas) {
            const centerX = 50;
            const centerY = 50;
            
            const radiusMax = 45;
            const radius = radiusMax * (1 - elevation / 90);
            
            const azimuthRad = (azimuth - 90) * Math.PI / 180;
            
            const x = centerX + radius * Math.cos(azimuthRad);
            const y = centerY + radius * Math.sin(azimuthRad);
            
            return { x: Math.max(5, Math.min(95, x)), y: Math.max(5, Math.min(95, y)) };
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            createStars();
            setupFilters();
            
            const locationBtn = document.getElementById('locationBtn');
            const notificationToggle = document.getElementById('notificationToggle');
            
            if (locationBtn) {
                locationBtn.addEventListener('click', getUserLocation);
            }
            
            if (notificationToggle) {
                notificationToggle.addEventListener('click', toggleNotifications);
            }
            
            createSkyMap();
            setInterval(createSkyMap, 60000);
        });
    </script>
</body>
</html>